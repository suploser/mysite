{% extends 'base.html' %}
{% load staticfiles %}
{% block title %}{{ blog.title }}{% endblock %}
{% block blogs_list_active %}active{% endblock %}
{% block header_extends %}<link rel="stylesheet" href={% static 'blog.css' %}> {% endblock %}
{% block content %}
<!-- {{ request.COOKIES }} -->
<div class="container">
    <div class="row">
        <div class="col-xs-10 col-xs-offset-1">
            <h3>{{ blog.title }}</h3>
            <ul class="blog-info">
                <li>作者: {{ blog.author }}</li>
                <li>分类: <a href={% url 'blogs_by_type' blog.blog_type.id %}>{{ blog.blog_type }}</a></li>
                <li>发表时间: {{ blog.created_time | date:"Y-m-d" }}&nbsp;&nbsp;&nbsp;&nbsp;阅读:{{ blog.get_read_num }}</li>
            </ul>
            <div class="blog-content">{{ blog.content | safe }}</div>
            <!-- {% autoescape off %}{{ blog.content }}{% endautoescape %} -->
            <div class="blog-more">
                {% if previous_blog %}
                    <p>上一篇:<a href="{% url 'blog_detail' previous_blog.id %}">{{ previous_blog.title }}</a></p>
                {% else %}
                    <p>上一篇:没有了!</p>
                {% endif %}
                {% if next_blog %}
                    <p>下一篇:<a href="{% url 'blog_detail' next_blog.id %}">{{ next_blog.title }}</a></p>
                {% else %}
                    <p>下一篇:没有了!</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div>
        <!-- {{ request.COOKIES }} -->
        <div class="comment-area">
            <h3 class="comment-area-title">提交评论</h3>
            <!-- sessionkey可能还存在于session表中,但没有对应的键值 -->
            {% if request.session.username %}
                <form id="comment-form" action="{% url 'update_comment' %}" method="POST" style="overflow:hidden;">
                    {% csrf_token %}
                    <label>{{ request.session.username }}~,欢迎评论！！</label>
                    {% for field in comment_form %}
                        {{ field }}
                    {% endfor %}
                    <span id='comment-error' class='text-danger pull-left'></span>
                    <input type="submit" class="btn btn-primary" value="提交" style="float: right;"> 
                </form>
            {% else %}
                <h4>未登录,请登录后评论!</h4>
                <a href="{% url 'login' %}?from={{ request.get_full_path }}" class="btn btn-primary">登录</a>&nbsp;或&nbsp;<a href="{% url 'regist' %}?from={{ request.get_full_path }}" class="btn btn-danger">注册</a>
            {% endif %}
        </div>
        <div class="comment-area">
            <h3 class="comment-area-title">评论列表</h3>
            <span id='comment-list'>
            {% for comment in comments %}
                <div>{{comment.user}}&nbsp;({{comment.create_time}}):&nbsp;{{ comment.content | safe}}</div>
            {% empty %}
                <div id="point">暂无评论！</div>
            {% endfor %}
            </span>
        </div>
        
    </div>
    
</div>

<script type="text/javascript" src="{% static "ckeditor/ckeditor-init.js" %}"></script>
<script type="text/javascript" src="{% static "ckeditor/ckeditor/ckeditor.js" %}"></script>
{% block scriptarea %}
    <script type="text/javascript">
    $("#comment-form").submit(function(){

        $('#comment-error').text('')
        // 更新评论内容到textarea
        CKEDITOR.instances.id_comment_content.updateElement();
        console.log($(this).serialize())
        if(CKEDITOR.instances.id_comment_content.document.getBody().getText().trim()==''){
            $('#comment-error').text('评论内容不能为空');
            return false;
        }
        $.ajax({
        url: "{% url 'update_comment' %}",
        type: "POST",
        data: $(this).serialize(),
        cache: false,
        success: function(data){
            console.log(data.status);
            if(data.status == 'SUCCESS'){
                $('#point').text()
                var comment_html = '<div>'+data.username+' ('+ data.comment_time+ ') :'+data.comment_content+'</div>';
                $('#comment-list').prepend(comment_html);
                CKEDITOR.instances.id_comment_content.setData('')
            }else{
                $('#comment-error').text(data.message)
            }
        },
        error: function(xhr){
            console.log(xhr);
        },
        });

        return false;
    });
</script>
{% endblock %}

{% endblock %}
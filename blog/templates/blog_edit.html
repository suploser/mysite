{% extends 'base.html' %}
{% load staticfiles %}
{% block title %}修改博文{% endblock %}
{% block header_extends %} 
    <script type="text/javascript" src="/ueditor/UE/ueditor.config.js"></script>
    <script type="text/javascript" src="/ueditor/UE/ueditor.all.js"></script>
    <script type="text/javascript" src="/ueditor/UE/lang/zh-cn/zh-cn.js"></script>
    <script type="text/javascript">
        var ue = UE.getEditor('editor');
        // 加载博客内容
        ue.ready(function(){
             $.ajax({
                url:"{% url 'ajax_get_content' blog.id %}",
                data:{},
                type:'GET',
                cache:false,
                success: function(data){
                    if(data.status='Success'){
                        var content = data.message;
                        ue.setContent(content);
                    }else{
                        $('.tip-text').text(data.message);
                    }
                },
                error: function(xhr){
                    $('.tip-text').text('内部错误,请稍后再试!')
                },
                });
        })
    </script>
{% endblock %}
{% block content %}
<div class="container">
    <form id="blog_add" action="" method="POST">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-1 col-md-offset-2" style="margin-top: 0.5em">博文标题</div>
            <div class="col-md-7">
            <input id="blog_title" type="text" value="{{ blog.title }}" name="blog_title" class="form-control" placeholder="请写入不超过50个字符的标题">
            </div>
        </div><br>
        <div class="row">
            <div class="col-md-1 col-md-offset-2">博客分类</div>
            <div class="col-md-7">
                <ul style="overflow: hidden;">                   
                    {% for tag in tags %}
                    <li style="display: inline-block;">
                        <input id="tag_{{tag.id}}" type="checkbox" name="tag" value="{{tag.id}}" {% if tag.checked %}checked{% endif %}>
                    <label for="tag_{{tag.id}}">{{tag.type_name}}</label>
                    </li>&nbsp;
                    {% endfor %}
                </ul>
            </div>
        </div><br>
        <input type="hidden" id="content" name="content">
    </form>
    <div class="row" style="min-height:600px">
        <div class="col-md-8 col-md-offset-2">
        <script id="editor" type="text/plain" style="width:100%;height:500px;"></script>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4 col-md-offset-6" style="text-align: right">
            <span class="tip-text text-danger"></span>
            <a id="blog_submit"  href="javascript:void(0);" class="btn btn-primary">发表博客</a>
        </div>
    </div>
</div>
{% endblock %}
{% block scriptarea %}
<script>
    // 前端验证数据
    function check_data(){
        $('.tip-text').text('');
        var title = $('#blog_title').val();
        if(title.length<=0 || title.length>=50){
            $('.tip-text').text('请输入一个不超过50个字符的标题');
            return false;
        }
        if($('input[name=tag]:checked').length == 0){
            $('.tip-text').text('请选择至少一个分类');
            return false;
        }
        if(!UE.getEditor('editor').hasContents()){
            $('.tip-text').text('请输入博客内容');
            return false;
        }
        return true;
    }
    $('#blog_submit').click(
        function(){
            if(!check_data()){
                return ;
            }
            $('.tip-text').text('发表博客中......');
            $('#blog_submit').addClass('disabled');
            var ue = UE.getEditor('editor');
            $('#content').val(ue.getContent());
            var data = $('#blog_add').serialize();
            $.ajax({
                url: '{% url "edit_ajax_add" blog.id %}',
                type:'POST',
                data: data,
                cache: false,
                success: function(data){
                    if(data.status == 'Success'){
                        $('.tip-text').text('修改成功,即将前往博客页面')
                        window.location.href = data.message;
                    }else{
                        $('.tip-text').text('修改博客出错'+data.message);
                    }
                },
                error: function(xhr){
                    console.log(xhr);
                    $('.tip-text').text('修改博文出错,请稍后再试!');
                }
            });
            $('#blog_submit').removeClass('disabled');
        });
</script>
{% endblock %}
